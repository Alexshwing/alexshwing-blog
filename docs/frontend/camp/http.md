# HTTP 实用指南

## 一、初始 HTTP
- Hyper Text Transfer Protocol
- 应用层协议, 基于 TCP 协议
- 请求 响应
- 简单可拓展
- 无状态
## 二、协议分析

### 报文
#### Method

| 方法名  |                               作用                               |
| :-----: | :--------------------------------------------------------------: |
|   GET   |  请求一个指定资源的表示形式，使用GET的请求应该只被用于获取数据   |
|  POST   | 用于将实体提交到指定的资源，通常导致在服务器上的状态变化或副作用 |
|   PUT   |             用请求有效载荷替换目标资源的所有当前表示             |
| DELETE  |                          删除指定的资源                          |
|  HEAD   |         请求一个与GET请求的响应相同的响应，但没有响应体          |
| CONNECT |               建立一个由目标资源标识的服务器的隧道               |
| OPTIONS |                    用于描述目标资源的通信选项                    |
|  TRACE  |             沿着到目标资源的路径执行一个消息环回测试             |
|  PATCH  |                      用于对资源应用部分修改                      |

- Safe(安全的): 不会修改服务器的数据的方法
  - GET
  - HEAD
  - OPTIONS
- Idempotent(幂等): 同样的请求被执行一次与连续执行多次的结果是一样的, 服务器的状态也是一样的, 所有 Safe 的方法都是 Idempotent 的。
  - GET
  - HEAD
  - OPTIONS
  - PUT
  - DELETE
  
#### 状态码
| 状态码 |                   信息                   |
| :----: | :--------------------------------------: |
|  1XX   |    指示信息，表示请求已接收，继续处理    |
|  2XX   |  成功，表示请求已被成功接收、理解、接受  |
|  3XX   | 重定向，要完成请求必须进行更进一步的操作 |
|  4XX   | 客户端错误，请求有语法错误或请求无法实现 |
|  5XX   |  服务器端错误，服务器未能实现合法的请求  |

- 200 OK - 客户端请求成功
- 301 - 资源(网页等)被永久转移到其他 URL
- 302 - 临时跳转
- 401 Unauthorized - 请求未经授权
- 404 - 请求资源不存在, 可能是输入了错误的 URL
- 500 - 服务器内部发生了不可预期的错误
- 504 Gateway Timeout - 网关或者代理的服务器无法在规定的时间内获得想要的响应

#### 常见请求头
|      请求头       |                                         作用                                          |
| :---------------: | :-----------------------------------------------------------------------------------: |
|      Accept       |          接收类型，表示浏览器支持的MIME类型（对标服务端返回的Content-Type）           |
|   Content-Type    |                             客户端发送出去实体内容的类型                              |
|   Cache-Control   |                       指定请求和响应遵循的循环机制，如no-cache                        |
| If-Modified-Since |          对应服务端的Last-Modified，用来匹配看文件是否变动，只能精确到1s之内          |
|      Expires      |               缓存控制，在这个时间内不会请求，直接使用缓存，服务端时间                |
|      Max-age      |              代表资源在本地缓存多少秒，有效时间内不会请求，而是使用缓存               |
|   If-None-Match   |                对应服务端的ETag，用来匹配文件内容是否改变（非常精确）                 |
|      Cookie       |                           有cookie并且同域访问时会自动带上                            |
|      Referer      | 该页面的来源URL（适用于所有类型的请求，会精确到详细页面地址，csrf拦截常用到这个字段） |
|      Origin       |         最初的请求是从哪里发起的（只会精确到端口），Origin比Referer更尊重隐私         |
|    User-Agent     |                         用户客户端的一些必要信息，如UA头部等                          |

#### 常用响应头
|           响应头            |                             作用                             |
| :-------------------------: | :----------------------------------------------------------: |
|        Content-Type         |                  服务器返回的实体内容的类型                  |
|        Cache-Control        |           指定请求和响应遵循的缓存机制，如no-cache           |
|        Last-Modified        |                    请求资源的最后修改时间                    |
|           Expires           |        应该在什么时候认为文档已经过期，从而不再缓存它        |
|           Max-age           |  客户端的本地资源应该缓存多少秒，开启了Cache-Control后有效   |
|            ETag             |           资源的特定版本的标识符，Etags类似于指纹            |
|         Set-Cookie          | 设置和页面关联的cookie，服务器通过这个头部把cookie传给客户端 |
|           Server            |                     服务器的一些相关信息                     |
| Access-Control-Allow-Origin |           服务器端允许请求的Origin头部（譬如为*）            |

- 缓存
  - 强缓存
    - Expires 时间戳
    - Cache-Control
    - 可缓存性
      - no-cache 协商缓存验证
      - no-store 不使用任何缓存
    - 到期
      - max-age 单位是秒，存储的最大周期，相对于请求的时间
    - 重新验证 * 重新加载
      - must-revalidate 一旦资源过期, 在成功向原始服务器验证之前, 不能使用
  - 协商缓存
    - Etag/If-None-Match 资源的特定版本的标识符，类似于指纹
    - Last-Modified/If-Modified-Since 最后修改时间

#### cookie
Set-Cookie-response
|         Name=value         |                                                 各种cookie的名称和值                                                 |
| :------------------------: | :------------------------------------------------------------------------------------------------------------------: |
|        Expires=Date        |                                  Cookie的有效期，缺省时Cookie仅在浏览器关闭之前有效                                  |
|         Path=Path          |                                    限制指定Cookie的发送范围的文件目录，默认为当前                                    |
|       Domain=domain        |                                   限制cookie生效的域名，默认为创建cookie的服务域名                                   |
|           secure           |                                        仅在HTTPS安全连接时，才可以发送Cookie                                         |
|          HttpOnly          |                                             JavaScript脚本无法获得Cookie                                             |
| SameSite=[None\Strict\Lax] | 1、None同站、跨站请求都可发送 2、Strict仅在同站发送 3、允许与顶级导航一起发送，并将与第三方网站发起的GET请求一起发送 |

### 发展
HTTP/2 概述: 更快、更稳定、更简单

帧(frame): HTTP/2 通信的最小单位, 每个帧都包含帧头, 至少也会标识出当前帧所属的数据流
- 交错发送, 接收方重组织

特性:
- HTTP/2 连接都是永久的, 而且仅需要每个来源一个连接
- 流控制: 阻止发送方向接收方发送大量数据的机制

## 三、常用场景
### 静态资源
缓存 + CDN + 文件名 hash
- CDN: Content Delivery Network
- 通过用户就近性和服务器负载的判断, CDN 确保内容以一种极为高效的方式为用户的请求提供服务

### 登录
#### 表单登录
1. 为什么有 options 的请求?

跨域, cross-origin。访问的 scheme, host name, port 有一个不一样就是跨域

跨域解决方案:
- CORS
- 代理服务器
  - 同源策略是浏览器的安全策略, 不是 HTTP 的
- Iframe

2. 向地址做了什么动作?
- 使用 POST 方法
- 目标域名 `sso.xx.com`
- 目标 `path/quick_login/v2`

3. 携带了哪些信息, 返回了哪些信息
- 携带信息
  - Post body, 数据格式为 form
  - 希望获取的数据格式为 json
  - 已有的 cookie
- 返回信息
  - 数据格式 json
  - cookie 信息
4. 下次进入页面为什么还是登录状态
- 鉴权
  - Session + cookie
  - JWT